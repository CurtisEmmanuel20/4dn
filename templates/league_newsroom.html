{% extends "base.html" %}
{% block content %}
<style>
  .newsroom-section-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    margin-top: 2.2rem;
  }
  .newsroom-section-header {
    font-size: 2.2rem;
    font-weight: 900;
    color: #00bfff;
    letter-spacing: 2px;
    text-shadow: 0 2px 12px #00bfff33, 0 0 2px #fff;
    margin: 0;
    text-align: left;
  }
  .sync-btn {
    font-size: 1.08rem;
    font-weight: 700;
    border-radius: 0.7rem;
    padding: 0.7rem 1.5rem;
    border: none;
    transition: background 0.2s, color 0.2s;
    box-shadow: 0 2px 12px #00bfff22;
    letter-spacing: 1px;
  }
  .sync-btn.sync {
    background: linear-gradient(90deg,#00bfff 60%,#00ff99 100%);
    color: #181c24;
  }
  .sync-btn.desync {
    background: linear-gradient(90deg,#ff4d4d 60%,#ffe066 100%);
    color: #181c24;
  }
  .newsroom-card {
    background: linear-gradient(120deg, #181c24 80%, #00bfff22 100%);
    border-radius: 1.5rem;
    box-shadow: 0 4px 32px 0 rgba(0,191,255,0.10), 0 1px 8px 0 rgba(0,255,153,0.10);
    border: 2.5px solid #00bfff44;
    padding: 2.2rem 1.2rem 1.2rem 1.2rem;
    margin-bottom: 2.5rem;
    position: relative;
    overflow: hidden;
    transition: box-shadow 0.2s, transform 0.15s;
  }
  .newsroom-card h5 {
    font-size: 1.35rem;
    font-weight: 800;
    color: #ffe066;
    letter-spacing: 1px;
    margin-bottom: 1.1rem;
    text-shadow: 0 2px 8px #00bfff33;
  }
  .newsroom-card ul.list-group {
    background: transparent;
    border-radius: 1rem;
    box-shadow: 0 2px 12px #00bfff11;
  }
  .newsroom-card .list-group-item {
    background: linear-gradient(90deg,#23272f 60%,#00bfff22 100%) !important;
    color: #f5f6fa !important;
    font-size: 1.08rem;
    font-weight: 600;
    border: none;
    border-bottom: 1px solid #23272f;
    border-radius: 0.5rem;
    margin-bottom: 0.3rem;
    box-shadow: 0 0 8px #00bfff11;
    padding: 0.85rem 1.1rem;
  }
  .newsroom-card .list-group-item:last-child {
    border-bottom: none;
  }
  .newsroom-card .card-text {
    font-size: 1.13rem;
    color: #00ff99;
    font-weight: 700;
    margin-bottom: 0.7rem;
    text-shadow: 0 2px 8px #00bfff22;
  }
  .flex-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }
  .btn-sync {
    background-color: #00bfff;
    color: #181c24;
    font-weight: 600;
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .btn-sync:hover {
    background-color: #009acd;
  }
</style>
<div class="container mt-4 text-light">
    <div class="newsroom-section-header-row">
      <div class="newsroom-section-header">üì∞ Fantasy Newsroom</div>
      <button id="syncToggleBtn" class="sync-btn sync">Sync League</button>
    </div>
    <div class="newsroom-card mb-4">
        <h5 class="card-title">Top Headlines</h5>
        <ul class="list-group list-group-flush">
            {% for headline in news_data.headlines %}
                <li class="list-group-item">{{ headline }}</li>
            {% endfor %}
        </ul>
    </div>
    <div class="newsroom-card mb-4">
        <h5 class="card-title">Recent Transactions</h5>
        <ul class="list-group list-group-flush">
            {% for tx in news_data.transactions %}
                <li class="list-group-item">{{ tx.type }} ‚Äì {{ tx.details }}</li>
            {% endfor %}
        </ul>
    </div>
    <div class="newsroom-card">
        <h5 class="card-title">Matchup Spotlight</h5>
        {% for match in news_data.matchups %}
            <p class="card-text">Week {{ match.week }} ‚Äì {{ match.spotlight }}</p>
        {% endfor %}
    </div>
    <div class="newsroom-card mb-4">
      <h4 class="mb-0 fw-bold" style="color:#ffe066;">üèÜ League Standings</h4>
      <small>Live league rankings update weekly</small>
      <div class="table-responsive" style="border-radius:1rem; max-height:420px; overflow-y:auto;">
        <table class="table table-dark table-hover align-middle mb-0" style="font-size:1.01rem;">
          <thead>
            <tr style="color:#00ff99;">
              <th class="text-center">Rank</th>
              <th>Team</th>
              <th>Owner</th>
              <th>W</th>
              <th>L</th>
              <th>T</th>
              <th>PF</th>
              <th>PA</th>
            </tr>
          </thead>
          <tbody>
            {% set mock_standings = [
              {'rank': 1, 'team': 'Gridiron Gurus', 'owner': 'Alex', 'w': 4, 'l': 1, 't': 0, 'pf': 612, 'pa': 501},
              {'rank': 2, 'team': 'Pigskin Prophets', 'owner': 'Jordan', 'w': 4, 'l': 1, 't': 0, 'pf': 599, 'pa': 488},
              {'rank': 3, 'team': 'Endzone Engineers', 'owner': 'Taylor', 'w': 3, 'l': 2, 't': 0, 'pf': 577, 'pa': 520},
              {'rank': 4, 'team': 'Fantasy Phantoms', 'owner': 'Morgan', 'w': 3, 'l': 2, 't': 0, 'pf': 570, 'pa': 545},
              {'rank': 5, 'team': 'Touchdown Titans', 'owner': 'Casey', 'w': 3, 'l': 2, 't': 0, 'pf': 561, 'pa': 533},
              {'rank': 6, 'team': 'Red Zone Renegades', 'owner': 'Sam', 'w': 3, 'l': 2, 't': 0, 'pf': 555, 'pa': 540},
              {'rank': 7, 'team': 'Blitz Brigade', 'owner': 'Jamie', 'w': 2, 'l': 3, 't': 0, 'pf': 540, 'pa': 560},
              {'rank': 8, 'team': 'Hail Mary Heroes', 'owner': 'Riley', 'w': 2, 'l': 3, 't': 0, 'pf': 528, 'pa': 570},
              {'rank': 9, 'team': 'Gridiron Goats', 'owner': 'Drew', 'w': 2, 'l': 3, 't': 0, 'pf': 520, 'pa': 590},
              {'rank': 10, 'team': 'Snap Count Savants', 'owner': 'Cameron', 'w': 1, 'l': 4, 't': 0, 'pf': 510, 'pa': 600},
              {'rank': 11, 'team': 'Pylon Pilots', 'owner': 'Skyler', 'w': 1, 'l': 4, 't': 0, 'pf': 498, 'pa': 610},
              {'rank': 12, 'team': 'Bye Week Ballers', 'owner': 'Quinn', 'w': 0, 'l': 5, 't': 0, 'pf': 480, 'pa': 620},
            ] %}
            {% for team in mock_standings %}
            <tr>
              <td class="text-center fw-bold">{{ team.rank }}</td>
              <td style="font-weight:700; color:#00bfff;">{{ team.team }}</td>
              <td style="color:#ffe066;">{{ team.owner }}</td>
              <td>{{ team.w }}</td>
              <td>{{ team.l }}</td>
              <td>{{ team.t }}</td>
              <td>{{ team.pf }}</td>
              <td>{{ team.pa }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
</div>
<!-- Sync League Modal -->
<div class="modal fade" id="syncLeagueModal" tabindex="-1" aria-labelledby="syncLeagueModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background:#181c24; color:#f5f6fa; border-radius:1.2rem;">
      <div class="modal-header" style="border-bottom:1px solid #23272f; background:#23273a; border-top-left-radius:1.2rem; border-top-right-radius:1.2rem;">
        <h5 class="modal-title fw-bold" id="syncLeagueModalLabel" style="color:#00bfff;">Sync Your League</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">Enter your league's API key or access token to sync your league data with 4DN. This allows us to pull your roster, matchups, and live stats.</div>
        <input type="text" id="leagueApiKey" class="form-control mb-2" placeholder="Enter API Key or Token">
        <div id="sync-league-feedback" class="text-danger small mb-2" style="display:none;"></div>
      </div>
      <div class="modal-footer" style="background:#23273a; border-bottom-left-radius:1.2rem; border-bottom-right-radius:1.2rem; border-top:1px solid #23272f;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-accent" id="confirmSyncBtn" style="background:linear-gradient(90deg,#00bfff 0%,#00ff99 100%); color:#181c24; font-weight:700; border:none;">Sync League</button>
      </div>
    </div>
  </div>
</div>
<script>
// League sync state (simulate with localStorage for demo)
function isLeagueSynced() {
  return localStorage.getItem('leagueSynced') === '1';
}
function setLeagueSynced(val) {
  localStorage.setItem('leagueSynced', val ? '1' : '0');
}
function updateSyncBtn() {
  const btn = document.getElementById('syncToggleBtn');
  if (!btn) return;
  if (isLeagueSynced()) {
    btn.textContent = 'Desync League';
    btn.classList.remove('sync');
    btn.classList.add('desync');
  } else {
    btn.textContent = 'Sync League';
    btn.classList.remove('desync');
    btn.classList.add('sync');
  }
}

// Render newsroom data (mock or real)
function renderNewsroom(data) {
  // Headlines
  const headlinesList = document.querySelector('.newsroom-card ul.list-group');
  if (headlinesList) {
    headlinesList.innerHTML = '';
    (data.headlines || []).forEach(headline => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = headline;
      headlinesList.appendChild(li);
    });
  }
  // Transactions
  const txList = document.querySelectorAll('.newsroom-card ul.list-group')[1];
  if (txList) {
    txList.innerHTML = '';
    (data.transactions || []).forEach(tx => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = `${tx.type} ‚Äì ${tx.details}`;
      txList.appendChild(li);
    });
  }
  // Matchups
  const matchupCard = document.querySelectorAll('.newsroom-card')[2];
  if (matchupCard) {
    matchupCard.querySelectorAll('.card-text').forEach(e => e.remove());
    (data.matchups || []).forEach(match => {
      const p = document.createElement('p');
      p.className = 'card-text';
      p.textContent = `Week ${match.week} ‚Äì ${match.spotlight}`;
      matchupCard.appendChild(p);
    });
  }
  // Standings
  const standingsTbody = document.querySelector('.newsroom-card table tbody');
  if (standingsTbody) {
    standingsTbody.innerHTML = '';
    (data.standings || []).forEach(team => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-center fw-bold">${team.rank}</td>
        <td style="font-weight:700; color:#00bfff;">${team.team}</td>
        <td style="color:#ffe066;">${team.owner}</td>
        <td>${team.w}</td>
        <td>${team.l}</td>
        <td>${team.t}</td>
        <td>${team.pf}</td>
        <td>${team.pa}</td>
      `;
      standingsTbody.appendChild(tr);
    });
  }
}

function loadNewsroomData() {
  if (isLeagueSynced()) {
    fetch('/api/league-newsroom-data')
      .then(res => res.json())
      .then(data => renderNewsroom(data))
      .catch(() => {});
  } else {
    // Use mock data from template context (already rendered by Jinja)
    // No action needed, as mock data is rendered by default
  }
}

document.addEventListener('DOMContentLoaded', function() {
  updateSyncBtn();
  loadNewsroomData();
  const btn = document.getElementById('syncToggleBtn');
  if (btn) {
    btn.addEventListener('click', function() {
      if (!isLeagueSynced()) {
        // Show modal to enter API key/token
        const modal = new bootstrap.Modal(document.getElementById('syncLeagueModal'));
        document.getElementById('leagueApiKey').value = '';
        document.getElementById('sync-league-feedback').style.display = 'none';
        modal.show();
      } else {
        // Desync: call backend, update state
        btn.disabled = true;
        fetch('/api/desync-league', { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            setLeagueSynced(false);
            updateSyncBtn();
            loadNewsroomData();
            btn.disabled = false;
            alert('League desynced successfully.');
          })
          .catch(() => {
            btn.disabled = false;
            alert('Error desyncing league.');
          });
      }
    });
  }
  // Confirm sync button in modal
  document.getElementById('confirmSyncBtn').addEventListener('click', function() {
    const apiKey = document.getElementById('leagueApiKey').value.trim();
    const feedback = document.getElementById('sync-league-feedback');
    const btn = this;
    if (!apiKey) {
      feedback.textContent = 'API key or token is required.';
      feedback.style.display = 'block';
      return;
    }
    btn.disabled = true;
    feedback.style.display = 'none';
    fetch('/api/sync-league', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ api_key: apiKey })
    })
      .then(res => res.json())
      .then((data) => {
        if (data.success) {
          setLeagueSynced(true);
          updateSyncBtn();
          loadNewsroomData();
          bootstrap.Modal.getInstance(document.getElementById('syncLeagueModal')).hide();
          alert('League synced successfully!');
        } else {
          feedback.textContent = data.error || 'Failed to sync league.';
          feedback.style.display = 'block';
        }
        btn.disabled = false;
      })
      .catch(() => {
        feedback.textContent = 'Error syncing league.';
        feedback.style.display = 'block';
        btn.disabled = false;
      });
  });
});
</script>
{% endblock %}
