{% extends 'base.html' %}
{% block content %}
<style>
  .stat-card {
    background: linear-gradient(120deg, #23272f 60%, #00bfff22 100%);
    border-radius: 1.25rem;
    box-shadow: 0 4px 32px 0 rgba(0,255,153,0.10), 0 1.5px 8px 0 rgba(0,191,255,0.10);
    color: #f5f6fa;
    transition: box-shadow 0.2s, transform 0.15s;
    padding: 2.2rem 1.2rem 1.5rem 1.2rem;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin-bottom: 1.5rem;
    position: relative;
    overflow: hidden;
  }
  .stat-card .stat-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #00ff99;
    letter-spacing: 1px;
    margin-bottom: 0.3rem;
    text-transform: uppercase;
  }
  .stat-card .stat-value {
    font-size: 2.3rem;
    font-weight: 800;
    color: #ffe066;
    margin-bottom: 0.2rem;
    letter-spacing: 1px;
    text-shadow: 0 0 8px #00ffd0a0;
  }
  .stat-card .stat-sub {
    font-size: 1.05rem;
    color: #b8c1ec;
    margin-top: 0.2rem;
    font-weight: 500;
  }
  .stat-card .start {
    color: #00ff99;
    font-weight: 700;
    font-size: 1.2rem;
    letter-spacing: 1px;
    background: linear-gradient(90deg, #00ff99 0%, #00bfff 100%);
    padding: 0.2em 0.8em;
    border-radius: 0.5rem;
    box-shadow: 0 0 8px #00ffd0a0;
  }
  .stat-card .sit {
    color: #ff416c;
    font-weight: 700;
    font-size: 1.2rem;
    letter-spacing: 1px;
    background: linear-gradient(90deg, #ffe066 0%, #ff416c 100%);
    padding: 0.2em 0.8em;
    border-radius: 0.5rem;
    box-shadow: 0 0 8px #ff416c80;
  }
  /* News Ticker Styles */
  #news-ticker {
    scrollbar-width: thin;
    overflow-x: auto;
  }
  #news-ticker::-webkit-scrollbar {
    height: 8px;
  }
  #news-ticker::-webkit-scrollbar-thumb {
    background: #00bfff;
    border-radius: 10px;
  }
  #news-ticker::-webkit-scrollbar-track {
    background: #181c24;
  }
  .news-item-card {
    min-width: 320px;
    max-width: 340px;
    background: linear-gradient(120deg, #23272f 80%, #00bfff22 100%);
    border-radius: 1rem;
    box-shadow: 0 2px 12px 0 rgba(0,191,255,0.10);
    border-left: 3px solid #00bfff;
    flex: 0 0 auto;
  }
  /* 4DN Fantasy Big Board Styles */
  #big-board-table tr {
    transition: background 0.15s;
  }
  #big-board-table tr:hover {
    background: rgba(0,191,255,0.08) !important;
  }
  #big-board-table td, #big-board-table th {
    vertical-align: middle;
  }
  .player-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 0.7rem;
    border: 2px solid #00bfff33;
    background: #23272f;
  }
  .score-badge {
    background: linear-gradient(90deg,#00ff99 60%,#00bfff 100%);
    color: #181c24;
    font-weight: 700;
    border-radius: 0.7rem;
    padding: 0.2em 0.9em;
    font-size: 1.05rem;
    box-shadow: 0 0 8px #00ffd0a0;
  }
</style>
<div class="container-fluid py-4">
  <div class="row g-4">
    <!-- Stat Cards -->
    <div class="col-12 col-md-4">
      <div class="stat-card text-center">
        <div class="stat-title"><span style="font-size:1.2rem;vertical-align:middle;">üìÖ</span> {{ countdown_label }}</div>
        <div class="stat-value">{{ countdown_value }}</div>
        <div class="stat-sub">NFL Regular Season</div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="stat-card text-center">
        <div class="stat-title" style="color:#00bfff;font-size:1.2rem;">About 4DN Fantasy</div>
        <div class="stat-value" style="font-size:1.1rem;color:#ffe066;font-weight:600;line-height:1.3;white-space:normal;">
          4DN is a data-driven platform designed to give serious managers a true analytical advantage. Our proprietary scoring system simplifies complex insights into clear, meaningful projections that help you make smarter decisions all season long.
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="stat-card text-center">
        <div class="stat-title"><span style="font-size:1.2rem;vertical-align:middle;">üîí</span> Your Season Pass</div>
        <div class="stat-value">
          {% if session.get('season_pass') %}
            <span class="start">Active</span>
          {% else %}
            <span class="sit">Inactive</span>
          {% endif %}
        </div>
        <div class="stat-sub">Unlocks all features</div>
      </div>
    </div>
  </div>
  <!-- 4DN Fantasy Big Board (Modernized) -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card bg-dark text-light shadow-lg border-0" style="border-radius:1.5rem;overflow:hidden;">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center py-3 px-4" style="background:linear-gradient(90deg,#181c24 70%,#00bfff22 100%);border-bottom:1px solid #23272f;">
          <div>
            <h4 class="mb-0 fw-bold" style="color:#00bfff;letter-spacing:1px;">üèà 4DN Fantasy Big Board</h4>
            <small class="text-muted">Top 100 | Updated Weekly | Proprietary 4DN Score</small>
          </div>
          <select id="positionFilter" class="form-select form-select-sm bg-dark text-light w-auto ms-3" style="min-width:120px;border:1px solid #00bfff;">
            <option value="ALL">All Positions</option>
            <option value="QB">QB</option>
            <option value="RB">RB</option>
            <option value="WR">WR</option>
            <option value="TE">TE</option>
          </select>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive" style="border-radius:0 0 1.5rem 1.5rem;">
            <table class="table table-dark table-hover align-middle mb-0" style="font-size:1.04rem;">
              <thead style="background:rgba(0,191,255,0.08);">
                <tr style="color:#00ff99;">
                  <th class="text-center">#</th>
                  <th>Player</th>
                  <th>Team</th>
                  <th>Pos</th>
                  <th>Bye</th>
                  <th style="color:#ffe066;">4DN Score</th>
                </tr>
              </thead>
              <tbody id="big-board-table">
                <!-- Injected by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Fantasy Football News Ticker -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card bg-dark text-light shadow mb-4" style="border-left: 4px solid #00bfff;">
        <div class="card-header d-flex align-items-center" style="background: #181c24;">
          <span style="font-size:1.3rem; color:#00bfff; margin-right:0.5rem;">üì∞</span>
          <h6 class="mb-0" style="letter-spacing:1px; font-weight:700; color:#00bfff;">Fantasy Football News</h6>
        </div>
        <div class="card-body py-2 px-0">
          <div id="news-ticker" class="d-flex flex-nowrap overflow-auto gap-3 px-3" style="scrollbar-width:thin;">
            <!-- News items injected by JS -->
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- AI Chat Assistant -->
  <div class="row mt-5" id="chat">
    <div class="col-12 col-lg-8 mx-auto">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="card-title mb-3">Fantasy Assistant AI Chat</h4>
          <div id="chat-log" class="bg-dark rounded p-3 mb-3" style="height: 220px; max-height: 220px; overflow-y: auto;"></div>
          <div class="input-group mb-2">
            <textarea id="chat-input" class="form-control" placeholder="Type your fantasy football question..." rows="2"></textarea>
            <button id="chat-submit" class="btn btn-accent" type="button">Ask 4DN</button>
          </div>
          <small class="text-muted d-block mt-2">Start/Sit, trade, and matchup advice powered by GPT-4o and real stats.</small>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
let fullBigBoard = [];

function renderBigBoard(players, filter = 'ALL') {
  const tbody = document.getElementById('big-board-table');
  tbody.innerHTML = '';

  players
    .filter(p => filter === 'ALL' || p.position === filter)
    .forEach(player => {
      const row = document.createElement('tr');
      // Use a placeholder avatar for realism
      const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(player.name)}&background=23272f&color=00bfff&size=72&bold=true`;
      row.innerHTML = `
        <td class="text-center fw-bold" style="font-size:1.1rem;">${player.rank}</td>
        <td class="d-flex align-items-center">
          <img src="${avatarUrl}" class="player-avatar me-2" alt="${player.name}">
          <span class="fw-semibold">${player.name}</span>
        </td>
        <td style="font-weight:600;letter-spacing:1px;">${player.team}</td>
        <td><span class="badge bg-secondary" style="font-size:1rem;">${player.position}</span></td>
        <td>${player.bye}</td>
        <td><span class="score-badge">${player.score.toFixed(2)}</span></td>
      `;
      tbody.appendChild(row);
    });
}

fetch('/api/fantasy-big-board')
  .then(res => res.json())
  .then(data => {
    fullBigBoard = data;
    renderBigBoard(fullBigBoard);
  })
  .catch(err => {
    document.getElementById('big-board-table').innerHTML =
      `<tr><td colspan="6" class="text-center">Error loading Big Board</td></tr>`;
    console.error(err);
  });

document.getElementById('positionFilter').addEventListener('change', (e) => {
  renderBigBoard(fullBigBoard, e.target.value);
});

document.getElementById("chat-submit").addEventListener("click", async () => {
  const input = document.getElementById("chat-input").value;
  const chatLog = document.getElementById("chat-log");
  if (!input) return;
  chatLog.innerHTML += `<div><strong>You:</strong> ${input}</div>`;
  document.getElementById("chat-input").value = "";
  const response = await fetch("/api/fantasy-chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: input })
  });
  const data = await response.json();
  chatLog.innerHTML += `<div><strong>4DN:</strong> ${data.response ? data.response : (data.error || 'Sorry, something went wrong.')}</div>`;
  chatLog.scrollTop = chatLog.scrollHeight;
});

// Fetch and display news ticker items
function fetchNewsTicker() {
  fetch('/api/fantasy-news')
    .then(res => res.json())
    .then(data => {
      const ticker = document.getElementById('news-ticker');
      ticker.innerHTML = '';
      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'py-2';
        div.innerHTML = `
          <a href="${item.url}" target="_blank" class="text-light text-decoration-none">
            <strong>${item.headline}</strong> - ${item.source}
          </a>
        `;
        ticker.appendChild(div);
      });
    })
    .catch(err => console.error('Error loading news ticker:', err));
}

// Initial fetch for news ticker
fetchNewsTicker();

fetch('/api/news')
  .then(res => res.json())
  .then(news => {
    const ticker = document.getElementById('news-ticker');
    if (!ticker) return;
    ticker.innerHTML = '';
    news.forEach(item => {
      const card = document.createElement('div');
      card.className = 'news-item-card p-3 mb-2';
      card.style = `min-width: 320px; max-width: 340px; background: linear-gradient(120deg, #23272f 80%, #00bfff22 100%); border-radius: 1rem; box-shadow: 0 2px 12px 0 rgba(0,191,255,0.10); border-left: 3px solid #00bfff; flex: 0 0 auto;`;
      card.innerHTML = `
        <div style='font-size:1.05rem;font-weight:700;color:#ffe066;'>${item.headline}</div>
        <div class='text-muted small mb-1' style='color:#b8c1ec!important;'>${item.time}</div>
        <div style='font-size:0.98rem;color:#f5f6fa;'>${item.summary}</div>
      `;
      ticker.appendChild(card);
    });
  })
  .catch(() => {
    const ticker = document.getElementById('news-ticker');
    if (ticker) ticker.innerHTML = '<div class="text-danger">Could not load news.</div>';
  });
</script>
{% endblock %}
